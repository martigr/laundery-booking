<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=2">
<title>Waschk√ºche ‚Äì Kalender</title>

<style>
body { font-family: sans-serif; padding: 1em; }
.calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
.day { border: 1px solid #ccc; min-height: 120px; padding: 4px; }
.header { font-weight: bold; text-align: center; padding: 8px 0; background: #f7f7f7; border: 1px solid #ccc; }
.date { font-weight: bold; margin-bottom: 4px; cursor: pointer; }
.slot { position: relative; }
.free { background: #d4edda; cursor: pointer; margin: 2px 0; }
.busy { background: #f8d7da; cursor: pointer; margin: 2px 0; }
.busy-foreign { background: #f8d7da; margin: 2px 0; }
.nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; gap: 1em; }
.nav a { margin: 0 8px; text-decoration: none; color: #007bff; }
.nav a:hover { text-decoration: underline; }
/* user controls */
.user-pill { display:inline-flex; align-items:center; gap:8px; background:#fff; border:1px solid #e1e8f0; padding:6px 8px; border-radius:20px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
.avatar { width:28px; height:28px; border-radius:50%; background:#007bff; color:#fff; display:inline-flex; align-items:center; justify-content:center; font-weight:700; }
.user-info { line-height:1; font-size:0.9em; color:#222; }
.user-info small { display:block; color:#666; font-size:0.75em; }
.btn-logout { margin-left:10px; background:#007bff; color:#fff; border:none; padding:0.7em; border-radius:4px; cursor:pointer; text-decoration:none; font-size:1em; }
.btn-logout:hover { background:#0056b3; }
/* ensure logout anchor color overrides .nav a default */
.nav a.btn-logout { color: #fff; }
.nav a.btn-logout:hover { color: #fff; text-decoration: none; }
</style>

<script>
// store selected day and slots in JS
window.selectedDay = null;
window.selectedSlots = [];

function selectSlot(day, slot) {
    fetch('/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ day: day, slot: slot, apartment: '{{ user["apartment_id"] }}' })
    }).then(function(res) {
        if (res.ok) {
            location.reload();
        } else {
            alert('Fehler beim Reservieren.');
        }
    }).catch(function() { alert('Netzwerkfehler beim Reservieren.'); });
}

function selectAllSlots(day) {
    var slots = {{ slots|tojson }};
    fetch('/', {        
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ day: day, slot: slots.join(','), apartment: '{{ user["apartment_id"] }}' })
    }).then(function(res) {
        if (res.ok) {
            location.reload();
        } else {
            alert('Fehler beim Reservieren.');
        }
    }).catch(function() { alert('Netzwerkfehler beim Reservieren.'); });
}

function deleteSlot(id) {
    fetch('/delete/' + id, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
    }).then(function(res) {
        if (res.ok) {
            location.reload();
        } else {
            alert('Fehler beim L√∂schen.');
        }
    }).catch(function() { alert('Netzwerkfehler beim L√∂schen.'); });
}
</script>
</head>

<body>

<h2>üß∫ {{ current.strftime("%B %Y") }}</h2>

<div class="nav">
    <div>
        <a href="/?month={{ prev_month }}">‚¨ÖÔ∏è</a>
        <a href="/?month={{ next_month }}">‚û°Ô∏è</a>
    </div>
    <div>
        <a class="user-pill" href="/profile" title="Profile">
            <span class="avatar">{{ user['username'][0]|upper }}</span>
            <span class="user-info"><strong>{{ user['username'] }}</strong><small>{{ user['apartment_name'] }}</small></span>
        </a>
        <a class="btn-logout" href="/logout">Logout</a>
    </div>
</div>

<div class="calendar">
    <div class="header" title="Montag">Mo</div>
    <div class="header" title="Dienstag">Di</div>
    <div class="header" title="Mittwoch">Mi</div>
    <div class="header" title="Donnerstag">Do</div>
    <div class="header" title="Freitag">Fr</div>
    <div class="header" title="Samstag">Sa</div>
    <div class="header" title="Sonntag">So</div>

    {% for _ in range(first_weekday) %}
    <div></div>
    {% endfor %}

    {% for d in range(1, days_in_month + 1) %}
    {% set day = "%04d-%02d-%02d"|format(current.year, current.month, d) %}
    <div class="day">
        <div class="date" onclick="selectAllSlots('{{ day }}')">{{ d }}</div>

        {% for s in slots %}
            {% set cell = grid.get(day, {}).get(s) %}
            {% if cell %}
                {% if cell.apartment_id == user['apartment_id'] %}
                <div class="slot busy" data-id="{{ cell.id }}" data-apartment="{{ cell.apartment_id }}" data-day="{{ day }}" data-slot="{{ s }}" onclick="deleteSlot({{ cell.id }})">
                    <span class="slot-label">üî¥ {{ cell.apartment_name }}</span>
                </div>
                {% else %}
                <div class="slot busy-foreign" data-id="{{ cell.id }}" data-apartment="{{ cell.apartment_id }}" data-day="{{ day }}" data-slot="{{ s }}">
                    <span class="slot-label">üî¥ {{ cell.apartment_name }}</span>
                </div>
                {% endif %}
            {% else %}
                <div class="slot free" data-day="{{ day }}" data-slot="{{ s }}"
                    onclick="selectSlot('{{ day }}','{{ s }}')">
                    üü¢ {{ s }}
                </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endfor %}
</div>

</body>
</html>
